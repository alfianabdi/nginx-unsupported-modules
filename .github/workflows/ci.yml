name: "Continuous Integration"
on:
  schedule:
    - cron: '0 2 * * *' # 2am UTC
  push:
    branches:
      - master
      - release/*
  create:
  pull_request:
    branches:
      - master

jobs:
  validate-commits:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code into the Go module directory
        uses: actions/checkout@v1
      - name: Commitsar check
        uses: docker://aevea/commitsar
  ci-pipeline:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        nginx-version: [ 1.18.0, 1.19.10, 1.20.1, 1.21.4 ]

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v2
      - name: Cache downloads
        uses: actions/cache@v2
        with:
          key: downloads-${{ hashFiles('nginx_build_versions.txt') }}
          path: downloads
      - name: Build Container Images
        shell: bash
        run: ./build.sh ${{ matrix.nginx-version }}
      - name: Push to Container Registry
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin && \
            ./push.sh "ghcr.io/nginxinc/"
